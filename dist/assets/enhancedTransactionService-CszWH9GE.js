var E=Object.defineProperty;var S=(l,e,a)=>e in l?E(l,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):l[e]=a;var g=(l,e,a)=>S(l,typeof e!="symbol"?e+"":e,a);import{s as w,P as D,m as T}from"./index-C9SSiDPj.js";import{realTransactionService as P}from"./realTransactionService-Bu0bwZ6C.js";import"./walletConnectivityService-DF_7EjHo.js";const b=[{id:"defi",name:"DeFi",color:"#34C759",icon:"TrendingUp",description:"Decentralized Finance activities"},{id:"trading",name:"Trading",color:"#FF9500",icon:"BarChart3",description:"Buy, sell, and swap transactions"},{id:"transfer",name:"Transfer",color:"#007AFF",icon:"ArrowUpDown",description:"Send and receive transactions"},{id:"payment",name:"Payment",color:"#FF3B30",icon:"CreditCard",description:"Payment transactions"},{id:"staking",name:"Staking",color:"#5856D6",icon:"Coins",description:"Staking and rewards"},{id:"other",name:"Other",color:"#8E8E93",icon:"MoreHorizontal",description:"Other transaction types"}],R=[{id:"date",label:"Date",required:!0},{id:"type",label:"Type",required:!0},{id:"token",label:"Token",required:!0},{id:"amount",label:"Amount",required:!0},{id:"value_usd",label:"Value (USD)",required:!1},{id:"status",label:"Status",required:!0},{id:"category",label:"Category",required:!1},{id:"hash",label:"Transaction Hash",required:!1},{id:"wallet_id",label:"Wallet ID",required:!1},{id:"gas_fee",label:"Gas Fee",required:!1},{id:"from_address",label:"From Address",required:!1},{id:"to_address",label:"To Address",required:!1}];class q{constructor(){g(this,"phase1FallbackActive",!1);g(this,"consecutiveFailures",0);g(this,"lastUpdate",null);g(this,"analyticsCache",new Map);g(this,"MAX_CONSECUTIVE_FAILURES",5);g(this,"CACHE_DURATION",10*60*1e3);g(this,"RETRY_DELAY",2e3);this.initialize()}async initialize(){var e;try{console.log("üöÄ Initializing Enhanced Transaction Analytics Service...");const a=((e=D)==null?void 0:e.enableRealTransactions)||!1;console.log(`üìä Detected Phase: ${a?"Phase 2":"Phase 1"}`),a||(console.log("‚ö†Ô∏è Phase 2 enhanced analytics not enabled, activating Phase 1 fallback"),this.activatePhase1Fallback()),console.log("‚úÖ Enhanced Transaction Analytics Service initialized successfully"),console.log(`üìà Current mode: ${this.phase1FallbackActive?"Phase 1 Fallback":"Phase 2 Active"}`)}catch(a){console.error("‚ùå Failed to initialize Enhanced Transaction Analytics Service:",a),console.log("üîÑ Activating Phase 1 fallback mode for stability"),this.activatePhase1Fallback()}}activatePhase1Fallback(){try{console.log("üîÑ Activating Phase 1 enhanced analytics fallback mode..."),this.phase1FallbackActive=!0,this.consecutiveFailures=0,this.lastUpdate=new Date,console.log("‚úÖ Phase 1 enhanced analytics fallback mode activated successfully"),console.log(`üìä Using mock analytics based on ${T.length} mock transactions`)}catch(e){console.error("‚ùå Failed to activate Phase 1 enhanced analytics fallback:",e)}}createMockAnalytics(e,a={}){try{const t=T.slice(0,50);let o=0;const c={},i={},n={};t.forEach(h=>{const d=parseFloat(h.amount||"0")*(Math.random()*100+50);o+=d;const k=this.categorizeTransaction(h);c[k]=(c[k]||0)+d;const p=Math.floor(Math.random()*6),f=new Date;f.setMonth(f.getMonth()-p);const F=f.toISOString().slice(0,7);i[F]=(i[F]||0)+d;const m=h.fromToken||"ethereum";n[m]||(n[m]={volume:0,count:0}),n[m].volume+=d,n[m].count+=1});const s=t.length,u=s>0?o/s:0,y=Object.entries(i).map(([h,r])=>({month:h,volume:r})).sort((h,r)=>h.month.localeCompare(r.month)),v=Object.entries(n).map(([h,r])=>({tokenId:h,...r})).sort((h,r)=>r.volume-h.volume).slice(0,10);return{totalTransactions:s,totalVolume:o,averageAmount:u,categoryBreakdown:c,monthlyVolume:y,topTokens:v}}catch(t){return console.error("‚ùå Error creating mock analytics:",t),{totalTransactions:0,totalVolume:0,averageAmount:0,categoryBreakdown:{},monthlyVolume:[],topTokens:[]}}}async getFilteredTransactions(e,a={},t={page:1,limit:20}){if(this.phase1FallbackActive)return console.log("üìä Phase 1 fallback mode active, returning mock filtered transactions"),this.createMockFilteredTransactions(e,a,t);const o=`filtered_${e}_${JSON.stringify(a)}_${JSON.stringify(t)}`,c=this.analyticsCache.get(o);if(c&&Date.now()-c.timestamp<this.CACHE_DURATION)return console.log("üíæ Returning cached filtered transactions"),c.data;try{console.log("üîÑ Fetching real filtered transactions...");const i=await P.getAllWalletTransactions(t.limit);if(i&&i.length>0){const s={transactions:i.slice(0,t.limit),total:i.length};return this.analyticsCache.set(o,{data:s,timestamp:Date.now()}),this.consecutiveFailures=0,this.lastUpdate=new Date,console.log(`‚úÖ Retrieved ${s.transactions.length} real filtered transactions`),s}const n=await C(e,a,t);return this.analyticsCache.set(o,{data:n,timestamp:Date.now()}),this.consecutiveFailures=0,this.lastUpdate=new Date,console.log(`‚úÖ Retrieved ${n.transactions.length} filtered transactions from Supabase`),n}catch(i){if(console.error("‚ùå Error fetching filtered transactions:",i),this.consecutiveFailures++,this.consecutiveFailures>=this.MAX_CONSECUTIVE_FAILURES)return console.log(`‚ö†Ô∏è ${this.consecutiveFailures} consecutive analytics failures detected, activating Phase 1 fallback`),this.activatePhase1Fallback(),this.createMockFilteredTransactions(e,a,t);const n=this.analyticsCache.get(o);return n?(console.log("üíæ Returning stale cached filtered transactions due to error"),n.data):(console.log("üîÑ No cached data available, returning mock filtered transactions"),this.createMockFilteredTransactions(e,a,t))}}createMockFilteredTransactions(e,a={},t={page:1,limit:20}){try{let o=[...T];a.transactionType&&(o=o.filter(s=>s.type===a.transactionType)),a.status&&(o=o.filter(s=>s.status===a.status)),a.tokenFilter&&(o=o.filter(s=>{var u,y;return((u=s.fromToken)==null?void 0:u.toLowerCase().includes(a.tokenFilter.toLowerCase()))||((y=s.toToken)==null?void 0:y.toLowerCase().includes(a.tokenFilter.toLowerCase()))}));const c=(t.page-1)*t.limit,i=c+t.limit;return{transactions:o.slice(c,i),total:o.length}}catch(o){return console.error("‚ùå Error creating mock filtered transactions:",o),{transactions:[],total:0}}}async getTransactionAnalytics(e,a={}){if(this.phase1FallbackActive)return console.log("üìä Phase 1 fallback mode active, returning mock analytics"),this.createMockAnalytics(e,a);const t=`analytics_${e}_${JSON.stringify(a)}`,o=this.analyticsCache.get(t);if(o&&Date.now()-o.timestamp<this.CACHE_DURATION)return console.log("üíæ Returning cached analytics"),o.data;try{console.log("üîÑ Fetching real transaction analytics...");const c=await M(e,a);return this.analyticsCache.set(t,{data:c,timestamp:Date.now()}),this.consecutiveFailures=0,this.lastUpdate=new Date,console.log("‚úÖ Retrieved real transaction analytics"),c}catch(c){if(console.error("‚ùå Error fetching transaction analytics:",c),this.consecutiveFailures++,this.consecutiveFailures>=this.MAX_CONSECUTIVE_FAILURES)return console.log(`‚ö†Ô∏è ${this.consecutiveFailures} consecutive analytics failures detected, activating Phase 1 fallback`),this.activatePhase1Fallback(),this.createMockAnalytics(e,a);const i=this.analyticsCache.get(t);return i?(console.log("üíæ Returning stale cached analytics due to error"),i.data):(console.log("üîÑ No cached data available, returning mock analytics"),this.createMockAnalytics(e,a))}}categorizeTransaction(e){var t,o;switch(((t=e.type)==null?void 0:t.toLowerCase())||((o=e.transaction_type)==null?void 0:o.toLowerCase())){case"stake":case"unstake":case"claim_rewards":return"staking";case"swap":case"buy":case"sell":return"trading";case"send":case"receive":return"transfer";case"payment":return"payment";case"liquidity_add":case"liquidity_remove":case"yield_farm":return"defi";default:return"other"}}getStatus(){return{lastUpdate:this.lastUpdate,phase1FallbackActive:this.phase1FallbackActive,consecutiveFailures:this.consecutiveFailures,currentMode:this.phase1FallbackActive?"Phase 1 Fallback":"Phase 2 Active",isPhase2Enabled:!1,analyticsCacheSize:this.analyticsCache.size,supportedFeatures:["filtering","analytics","categorization","export"],cacheEntries:Array.from(this.analyticsCache.keys())}}isInFallbackMode(){return this.phase1FallbackActive}async attemptRecovery(){if(!this.phase1FallbackActive)return console.log("üìä Not in fallback mode, no recovery needed"),!0;console.log("üîÑ Attempting recovery from Phase 1 enhanced analytics fallback mode...");try{return this.phase1FallbackActive=!1,this.consecutiveFailures=0,await this.getTransactionAnalytics("test_user",{}),console.log("‚úÖ Successfully recovered from enhanced analytics fallback mode"),!0}catch(e){return console.error("‚ùå Error during enhanced analytics recovery attempt:",e),this.activatePhase1Fallback(),!1}}clearCache(){this.analyticsCache.clear(),console.log("üßπ Enhanced analytics cache cleared")}destroy(){try{this.clearCache(),this.phase1FallbackActive=!1,this.consecutiveFailures=0,console.log("üßπ Enhanced Transaction Analytics Service destroyed")}catch(e){console.error("‚ùå Error during enhanced analytics service cleanup:",e)}}}const $=new q,C=async(l,e={},a={page:1,limit:20})=>{try{let t=w.from("transactions").select(`
        *,
        tokens:from_token_id (
          id,
          symbol,
          name,
          logo,
          decimals,
          price
        )
      `,{count:"exact"}).eq("user_id",l);e.walletId&&(t=t.eq("wallet_id",e.walletId)),e.transactionType&&(t=t.eq("transaction_type",e.transactionType)),e.status&&(t=t.eq("status",e.status)),e.tokenId&&(t=t.eq("from_token_id",e.tokenId)),e.dateRange?t=t.gte("timestamp",e.dateRange.from.toISOString()).lte("timestamp",e.dateRange.to.toISOString()):(e.dateFrom&&(t=t.gte("timestamp",e.dateFrom)),e.dateTo&&(t=t.lte("timestamp",e.dateTo))),e.tokenFilter&&(t=t.or(`tokens.symbol.ilike.%${e.tokenFilter}%,tokens.name.ilike.%${e.tokenFilter}%`)),e.amountMin&&(t=t.gte("from_amount",e.amountMin.toString())),e.amountMax&&(t=t.lte("from_amount",e.amountMax.toString())),e.category&&(t=t.eq("category",e.category));const o=(a.page-1)*a.limit;t=t.order("timestamp",{ascending:!1}).range(o,o+a.limit-1);const{data:c,error:i,count:n}=await t;return i?(console.error("Error fetching filtered transactions:",i),{transactions:[],total:0}):{transactions:c||[],total:n||0}}catch(t){return console.error("Error in getFilteredTransactions:",t),{transactions:[],total:0}}},M=async(l,e={})=>{try{let a=w.from("transactions").select(`
        *,
        tokens:from_token_id (
          id,
          symbol,
          name,
          price
        )
      `).eq("user_id",l);e.walletId&&(a=a.eq("wallet_id",e.walletId)),e.dateFrom&&(a=a.gte("timestamp",e.dateFrom)),e.dateTo&&(a=a.lte("timestamp",e.dateTo));const{data:t,error:o}=await a;if(o||!t)return console.error("Error fetching transaction analytics:",o),{totalTransactions:0,totalVolume:0,averageAmount:0,categoryBreakdown:{},monthlyVolume:[],topTokens:[]};const c=t.length;let i=0;const n={},s={},u={};t.forEach(r=>{var A,_;const d=parseFloat(r.from_amount||"0"),k=((A=r.tokens)==null?void 0:A.price)||0,p=d*k;i+=p;const f=r.category||"other";n[f]=(n[f]||0)+p;const F=new Date(r.timestamp).toISOString().slice(0,7);s[F]=(s[F]||0)+p;const m=r.from_token_id;m&&(u[m]||(u[m]={volume:0,count:0,symbol:((_=r.tokens)==null?void 0:_.symbol)||"Unknown"}),u[m].volume+=p,u[m].count+=1)});const y=c>0?i/c:0,v=Object.entries(s).map(([r,d])=>({month:r,volume:d})).sort((r,d)=>r.month.localeCompare(d.month)),h=Object.entries(u).map(([r,d])=>({tokenId:r,...d})).sort((r,d)=>d.volume-r.volume).slice(0,10);return{totalTransactions:c,totalVolume:i,averageAmount:y,categoryBreakdown:n,monthlyVolume:v,topTokens:h}}catch(a){return console.error("Error in getTransactionAnalytics:",a),{totalTransactions:0,totalVolume:0,averageAmount:0,categoryBreakdown:{},monthlyVolume:[],topTokens:[]}}},z=async(l,e,a)=>{try{const{error:t}=await w.from("transactions").update({category:e}).eq("id",l).eq("user_id",a);return t?(console.error("Error updating transaction category:",t),!1):!0}catch(t){return console.error("Error in updateTransactionCategory:",t),!1}},O=l=>{var a;switch((a=l.transaction_type)==null?void 0:a.toLowerCase()){case"stake":case"unstake":case"claim_rewards":return"staking";case"swap":case"buy":case"sell":return"trading";case"send":case"receive":return"transfer";case"payment":return"payment";case"liquidity_add":case"liquidity_remove":case"yield_farm":return"defi";default:return"other"}},L=async(l,e)=>{try{let a={};if(e.dateRange==="custom"&&e.customDateRange)a.dateRange=e.customDateRange;else{const n=new Date,s=new Date;switch(e.dateRange){case"last30days":s.setDate(n.getDate()-30);break;case"last90days":s.setDate(n.getDate()-90);break;case"alltime":s.setFullYear(2020);break}a.dateRange={from:s,to:n}}const{transactions:t}=await C(l,a,{page:1,limit:1e4}),o=e.includeFields.map(n=>{const s=R.find(u=>u.id===n);return(s==null?void 0:s.label)||n}),c=t.map(n=>e.includeFields.map(s=>{var u,y;switch(s){case"date":return new Date(n.timestamp).toLocaleDateString();case"type":return n.transaction_type||"Unknown";case"token":return((u=n.tokens)==null?void 0:u.symbol)||"Unknown";case"amount":return n.from_amount||"0";case"value_usd":const v=parseFloat(n.from_amount||"0"),h=((y=n.tokens)==null?void 0:y.price)||0;return(v*h).toFixed(2);case"status":return n.status||"Unknown";case"category":const r=O(n),d=b.find(k=>k.id===r);return(d==null?void 0:d.name)||"Other";case"hash":return n.hash||"";case"wallet_id":return n.wallet_id||"";case"gas_fee":return n.gas_fee||"0";case"from_address":return n.from_address||"";case"to_address":return n.to_address||"";default:return""}}));return[o,...c].map(n=>n.map(s=>`"${s}"`).join(",")).join(`
`)}catch(a){throw console.error("Error exporting transactions to CSV:",a),new Error("Failed to export transactions")}},B=l=>b.find(e=>e.id===l)||b[5];export{R as EXPORT_FIELDS,b as TRANSACTION_CATEGORIES,O as categorizeTransaction,$ as default,$ as enhancedTransactionAnalyticsService,L as exportTransactionsToCSV,C as getFilteredTransactions,M as getTransactionAnalytics,B as getTransactionCategoryInfo,z as updateTransactionCategory};
